name: Build, Push and Deploy

on:
  push:
    branches:
      - prod  # Trigger the workflow on push to prod branch

jobs:
  build-docker-and-push-to-dockerhub:
    runs-on: ubuntu-latest
    # ... (existing build and push steps)

  deploy-to-kubernetes:
    runs-on: ubuntu-latest
    needs: build-docker-and-push-to-dockerhub
    steps:
      - name: Check Out Repository
        uses: actions/checkout@v2

      - name: SSH and Deploy to Kubernetes
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to Helm chart directory (modify if necessary)
            cd http-server-chart

            # Deploy using Helm
            helm upgrade --install my-release . --namespace default --set image.repository=saeed9124/ruby-app,image.tag=latest

